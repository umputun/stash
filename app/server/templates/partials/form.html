{{define "form"}}
<div class="modal-header">
    <h2>{{if .IsNew}}Create Key{{else}}Edit Key{{end}}</h2>
    <div class="modal-header-right">
        <select id="format" name="format" form="kv-form" class="format-select">
            {{range .Formats}}
            <option value="{{.}}"{{if eq . $.Format}} selected{{end}}>{{.}}</option>
            {{end}}
        </select>
        <button class="modal-close" onclick="hideModal('main-modal')">&times;</button>
    </div>
</div>
<form id="kv-form" {{if .IsNew}}hx-post="{{.BaseURL}}/web/keys"{{else}}hx-put="{{.BaseURL}}/web/keys/{{.Key | urlEncode}}"{{end}}
      hx-target="#keys-table"
      hx-swap="innerHTML"
      data-close-modal>
    {{if not .IsNew}}<input type="hidden" name="updated_at" value="{{.UpdatedAt}}">{{end}}
    <div class="modal-body">
        {{if .Conflict}}
        <div class="conflict-warning">
            <strong>Conflict detected:</strong> This key was modified by another user while you were editing.
            <details>
                <summary>Show current server value</summary>
                <pre class="conflict-value">{{.ServerValue}}</pre>
            </details>
            <div class="conflict-actions">
                <button type="button" class="btn btn-secondary" hx-get="{{.BaseURL}}/web/keys/edit/{{.Key | urlEncode}}" hx-target="#modal-content" hx-swap="innerHTML">Reload</button>
                <button type="submit" name="force_overwrite" value="true" class="btn btn-danger-filled">Overwrite</button>
            </div>
        </div>
        <input type="hidden" name="server_updated_at" value="{{.ServerUpdatedAt}}">
        {{else if .Error}}
        <div class="error-message" id="form-error">{{.Error}}</div>
        {{end}}
        <div class="form-group">
            <label for="key">Key</label>
            <input type="text" id="key" name="key" value="{{.Key}}"
                   {{if not .IsNew}}readonly{{end}}
                   placeholder="e.g., app/config/database"
                   oninput="var e=document.getElementById('form-error');if(e)e.remove()"
                   required>
            {{if .IsNew}}
            <div class="form-hint">Use slashes to organize keys hierarchically</div>
            {{end}}
        </div>
        <div class="form-group">
            <label for="value">Value</label>
            {{if .IsBinary}}
            <span class="binary-indicator">Base64 encoded</span>
            <input type="hidden" name="is_binary" value="true">
            {{end}}
            <textarea id="value" name="value" placeholder="Enter value..."
                      oninput="var e=document.getElementById('form-error');if(e)e.remove();var s=document.getElementById('save-btn');if(s)s.style.display='';var f=document.getElementById('force-btn');if(f)f.style.display='none'"
                      required>{{.Value}}</textarea>
        </div>
    </div>
    {{if not .Conflict}}
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('main-modal')">Cancel</button>
        <button type="submit" id="save-btn" class="btn btn-primary"{{if .CanForce}} style="display:none"{{end}}>{{if .IsNew}}Create{{else}}Save{{end}}</button>
        {{if .CanForce}}
        <button type="submit" id="force-btn" name="force" value="true" class="btn btn-danger-filled">Submit Anyway</button>
        {{end}}
    </div>
    {{end}}
</form>
{{if not .IsNew}}
<style>
    #main-modal .modal { --modal-width: {{.ModalWidth}}px; }
    #main-modal textarea#value { min-height: {{.TextareaHeight}}px; }
</style>
{{end}}
{{end}}
